# MariaDB Helm Chart

A Helm chart for deploying a MariaDB instance using the [mariadb-operator](https://github.com/mariadb-operator/mariadb-operator).

This chart provides a highly configurable way to deploy MariaDB on Kubernetes, with support for replication, backups, metrics, and automatic database/user creation.

## Prerequisites

* Kubernetes 1.19+
* Helm 3.2+
* The [mariadb-operator](https://github.com/mariadb-operator/mariadb-operator) must be installed in your cluster.

## Installing the Chart

To install the chart with the release name `my-release`:

```bash
helm install my-release .
```

## Uninstalling the Chart

To uninstall/delete the `my-release` deployment:

```bash
helm uninstall my-release
```

## Configuration

The following table lists the configurable parameters of the MariaDB chart and their default values.

| Parameter | Description | Default |
| --- | --- | --- |
| `imagePullSecrets` | Global imagePullSecrets for all components. These are used if component-specific `imagePullSecrets` are not provided. | `[]` |
| `architecture` | MariaDB architecture. Allowed values: `standalone` or `replication`. | `standalone` |
| `replicas` | Number of replicas (used when architecture is replication). | `2` |
| `image.registry` | Global Docker image registry. | `docker.io` |
| `image.repository` | The image repository to use for the MariaDB instance. | `mariadb` |
| `image.tag` | The image tag to use. | `"10.6"` |
| `image.pullPolicy` | The image pull policy. | `IfNotPresent` |
| `image.pullSecrets` | imagePullSecrets for the main MariaDB image. Overrides global `imagePullSecrets`. | `[]` |
| `auth.existingSecret` | Name of an existing Kubernetes secret to use for authentication. If specified along with `auth.userPasswordKey` or `auth.replPasswordKey`, the corresponding password will not be generated by the chart. | `""` |
| `auth.rootPasswordKey` | Key in the secret containing the root password. | `""` |
| `auth.userPasswordKey` | Key in the existing secret containing the user password. If specified along with `auth.existingSecret`, the user password will not be generated by the chart. | `""` |
| `auth.replPasswordKey` | Key in the existing secret containing the replication password. If specified along with `auth.existingSecret`, the replication password will not be generated by the chart. | `""` |
| `auth.database` | Database to be created on startup. | `""` |
| `auth.username` | User to be created on startup. | `""` |
| `auth.password` | Password for the user. | `""` |
| `auth.replicationPassword` | Password for replication user. | `""` |
| `myCnf` | Custom MariaDB configuration (my.cnf). | `[mariadb]\nbind-address=0.0.0.0\ndefault_storage_engine=InnoDB\nbinlog_format=row\ninnodb_autoinc_lock_mode=2\nmax_allowed_packet=256M` |
| `resources.limits.cpu` | CPU limits for the MariaDB container. | `500m` |
| `resources.limits.memory` | Memory limits for the MariaDB container. | `1Gi` |
| `resources.requests.cpu` | CPU requests for the MariaDB container. | `200m` |
| `resources.requests.memory` | Memory requests for the MariaDB container. | `256Mi` |
| `persistence.size` | The size of the persistent volume. | `10Gi` |
| `service.type` | Kubernetes Service type for the common service. | `ClusterIP` |
| `service.annotations` | Annotations for the common service. | `{}` |
| `primary.containerPorts.mysql` | The port to expose MariaDB on. | `3306` |
| `primary.automaticFailover` | Enable automatic failover for primary. | `true` |
| `primary.service.type` | Kubernetes Service type for the primary instance. | `ClusterIP` |
| `primary.service.annotations` | Annotations for the primary service. | `{}` |
| `secondary.enabled` | Enable secondary replicas. | `false` |
| `secondary.service.type` | Kubernetes Service type for secondary instances. | `ClusterIP` |
| `secondary.service.annotations` | Annotations for the secondary service. | `{}` |
| `secondary.semiSync.enabled` | Enable semi-synchronous replication. | `true` |
| `backup.enabled` | Enable or disable backups. | `false` |
| `backup.databases` | List of databases to backup. Default backup all databases. | `[]` |
| `backup.schedule` | The cron schedule for backups. | `"0 0 * * *"` |
| `backup.timezone` | Timezone for the backup schedule. | `"America/Vancouver"` |
| `backup.compression` | Compression algorithm for backups. | `bzip2` |
| `backup.storage` | Configuration for backup storage (PVC, NFS, S3). | `{}` |
| `backup.imagePullSecrets` | imagePullSecrets for the backup job. Overrides global `imagePullSecrets`. | `[]` |
| `backup.stagingStorage.enabled` | Enable staging storage (required for S3). | `false` |
| `backup.args` | Arguments to pass to the backup command. | `[]` |
| `backup.retention` | Retention policy for backups. | `720h` |
| `backup.logLevel` | Log level for the backup job. | `info` |
| `backup.resources` | Resource requests and limits for the backup job. | `{requests: {cpu: 100m, memory: 128Mi}, limits: {cpu: 300m, memory: 512Mi}}` |
| `bootstrapFrom` | Configuration to bootstrap new MariaDB instances from existing backups/sources. This section is only rendered if specific bootstrap fields are configured (excluding `imagePullSecrets`). | `{}` |
| `bootstrapFrom.imagePullSecrets` | imagePullSecrets for the bootstrap job. Overrides global `imagePullSecrets`. | `[]` |
| `restore.enabled` | Enable or disable restore. | `false` |
| `restore.backupName` | The name of the backup to restore from. | `""` |
| `restore.imagePullSecrets` | imagePullSecrets for the restore job. Overrides global `imagePullSecrets`. | `[]` |
| `metrics.enabled` | Enable or disable metrics. | `false` |
| `metrics.exporter.image` | The image for the metrics exporter. | `prom/mysqld-exporter:v0.18.0` |
| `metrics.exporter.imagePullPolicy` | The image pull policy for the metrics exporter. | `IfNotPresent` |
| `metrics.exporter.imagePullSecrets` | Image pull secrets for the metrics exporter. Overrides global `imagePullSecrets`. | `[]` |
| `metrics.exporter.resources` | Resources for the metrics exporter. | `{}` |
| `metrics.serviceMonitor.jobLabel` | Job label for the ServiceMonitor. | `""` |
| `metrics.serviceMonitor.interval` | The scrape interval for the ServiceMonitor. | `30s` |
| `metrics.serviceMonitor.scrapeTimeout` | The scrape timeout for the ServiceMonitor. | `10s` |
| `metrics.username` | Username of the monitoring user. | `""` |
| `metrics.passwordSecretKeyRef` | Reference to the password secret for the monitoring user. | `{}` |
| `databases` | List of custom databases and users to create (each item should have `name`, `user`, `password`). | `[]` |

## Testing
```bash
# standard
helm install --debug mariadb-test .
# replication
helm install --debug mariadb-test --set architecture=replication --set replicas=4 .
# with custom user and database
helm install --debug mariadb-test --set architecture=replication --set replicas=4  --set auth.database=dbtest --set auth.username=dbtest .

# replication with backup enabled
helm install --debug mariadb-test --set architecture=replication --set auth.database=dbtest --set auth.username=dbtest \
  --set backup.enabled=true --set backup.schedule="0 0 * * *" \
  --set backup.storage.volume.nfs.server=storageverf.lthub.ubc.ca \
  --set backup.storage.volume.nfs.path=\/test \
  .

# bootstrap from existing data, the restore file name should follow this format: backup.2024-08-26T12:24:34Z.sql and located in the nfs path
helm install --debug mariadb-test --set architecture=replication --set auth.database=dbtest --set auth.username=dbtest \
  --set bootstrapFrom.volume.nfs.server=storageverf.lthub.ubc.ca \
  --set bootstrapFrom.volume.nfs.path=\/hotcrp-test \
  --set bootstrapFrom.targetRecoveryTime=`date -u +"%Y-%m-%dT%H:%M:%SZ"` \
  --set bootstrapFrom.restoreJob.args\[0\]="dbtest" \
  .

# clean up
helm uninstall mariadb-test
kubectl delete pvc storage-mariadb-test-0 storage-mariadb-test-1
kubectl delete secret mariadb-test-root
```
